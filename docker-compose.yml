version: '3.8'

services:
  # Next.js Frontend
  next-frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://express-integration:3000
    depends_on:
      - express-integration
    command: npm run serve:next
    volumes:
      - ./apps/next-frontend/public:/app/apps/next-frontend/public

  # Express Integration (PR Review Service)
  express-integration:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - GITHUB_AUTHID=${GITHUB_AUTHID}
      - GITHUB_AUTHSECRET=${GITHUB_AUTHSECRET}
      - GITHUB_REDIRECT_URI=${GITHUB_REDIRECT_URI}
      - GITHUB_SCOPE=${GITHUB_SCOPE}
      - BITBUCKET_CLIENT_ID=${BITBUCKET_CLIENT_ID}
      - BITBUCKET_CLIENT_SECRET=${BITBUCKET_CLIENT_SECRET}
      - BITBUCKET_REDIRECT_URI=${BITBUCKET_REDIRECT_URI}
      - BITBUCKET_SCOPE=${BITBUCKET_SCOPE}
      - SAAS_API_BASE=${SAAS_API_BASE}
    command: npm run serve:express
    volumes:
      - ./apps/express-integration/src:/app/apps/express-integration/src

  # Optional: Add a reverse proxy for production
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - next-frontend
      - express-integration
    profiles:
      - production

volumes:
  app-data:
